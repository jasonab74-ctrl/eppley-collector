<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Eppley Collector — Data Status</title>
  <meta name="description" content="Live status for the Eppley Collector dataset. Client-side audit of CSV freshness, counts, and availability." />
  <style>
    :root{
      --bg:#0b0c10;--panel:#121318;--ink:#e9eef7;--muted:#a8b3c7;--brand:#53d3a1;
      --good:#2ecc71;--warn:#f39c12;--bad:#e74c3c;--chip:#1c1f28;--table:#171923;--line:#222632;--link:#8bd8ff;
    }
    html,body{background:var(--bg);color:var(--ink);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0}
    .wrap{max-width:1000px;margin:auto;padding:24px}
    h1{margin:4px 0 6px;font-weight:800;letter-spacing:.2px}
    p.lead{color:var(--muted);margin:0 0 16px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    .chip{background:var(--chip);border:1px solid var(--line);padding:6px 10px;border-radius:999px;color:var(--muted);font-weight:700}
    .chip.ok{color:#0ddc86;background:rgba(13,220,134,.08);border-color:rgba(13,220,134,.28)}
    .chip.warn{color:#ffb648;background:rgba(255,182,72,.08);border-color:rgba(255,182,72,.28)}
    .chip.err{color:#ff6b6b;background:rgba(255,107,107,.08);border-color:rgba(255,107,107,.28)}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin:6px 0 16px}
    .btn{background:#1f2430;border:1px solid var(--line);color:var(--ink);text-decoration:none;padding:8px 12px;border-radius:10px;font-weight:800}
    .btn:hover{border-color:#3a4154}
    .grid{display:grid;gap:16px}
    @media(min-width:860px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:16px}
    .meta{display:flex;gap:12px;flex-wrap:wrap;color:var(--muted);font-weight:700}
    .stat{display:flex;gap:8px;align-items:center;background:var(--chip);border:1px solid var(--line);border-radius:10px;padding:8px 10px}
    .k{color:#9fb3d0}
    table{width:100%;border-collapse:collapse;background:var(--table);border:1px solid var(--line);border-radius:12px;overflow:hidden}
    th,td{padding:10px 12px;border-bottom:1px solid var(--line);vertical-align:top}
    th{color:#b9c7dc;text-align:left;font-weight:800;background:#141723;position:sticky;top:0}
    td.small{color:var(--muted)}
    td.num{text-align:right;white-space:nowrap}
    a{color:var(--link);text-decoration:none}
    a:hover{text-decoration:underline}
    .ok{color:var(--good)} .warn{color:var(--warn)} .err{color:var(--bad)}
    .foot{color:var(--muted);margin-top:14px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .tip{margin-top:12px;color:#ffb648}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Data Status</h1>
  <p class="lead">Live, client-side audit of <span class="mono">/output/*.csv</span>: availability, row counts, and last-modified.</p>

  <div class="chips" id="badges">
    <span class="chip ok" id="overall">overall: checking…</span>
    <span class="chip" id="lastUpdated">Last updated: …</span>
  </div>

  <div class="btnrow">
    <a class="btn" href="index.html">Back to Index</a>
    <a class="btn" href="https://github.com/jasonab74-ctrl/eppley-collector" target="_blank" rel="noopener">View Repo</a>
    <a class="btn" href="https://github.com/jasonab74-ctrl/eppley-collector/actions" target="_blank" rel="noopener">GitHub Actions</a>
  </div>

  <div class="grid" style="margin-top:8px">
    <div class="card">
      <h3>Summary</h3>
      <div class="meta" style="margin-top:8px">
        <div class="stat"><span class="k">Files present</span> <span id="filesPresent">0</span></div>
        <div class="stat"><span class="k">Total rows</span> <span id="totalRows">0</span></div>
        <div class="stat"><span class="k">Issues</span> <span id="issueCount">0</span></div>
      </div>
      <p class="foot">Status logic: <span class="ok">ok</span> = loads & meets threshold; <span class="warn">warn</span> = loads but thin; <span class="err">error</span> = fetch failed.</p>
      <div id="ytTip" class="tip" style="display:none;">
        Heads up: <b>youtube_all.csv</b> is missing or empty. Make sure your Actions secret <span class="mono">YT_API_KEY</span> is set (Settings → Secrets → Actions).
      </div>
    </div>

    <div class="card">
      <h3>Notes</h3>
      <ul style="margin:10px 0 0 18px;line-height:1.6">
        <li>Counts come from client-side CSV line counts; no server involved.</li>
        <li>“Last updated” is read from the CSV’s <span class="mono">Last-Modified</span> header (UTC).</li>
        <li>Thresholds are conservative and only used to flag obvious gaps.</li>
      </ul>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3>Per-file checks</h3>
    <table id="files">
      <thead>
        <tr>
          <th style="width:30%">File</th>
          <th>Description</th>
          <th style="width:12%">Rows</th>
          <th style="width:18%">Last modified (UTC)</th>
          <th style="width:12%">Status</th>
          <th style="width:10%">CSV</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p class="foot">Site base: <a id="siteUrl" href="#" target="_blank" rel="noopener"></a></p>
  </div>
</div>

<script>
// ---- Configuration
const FILES = [
  { name:"wordpress_posts.csv", desc:"All blog & Q&A posts with extracted content.", min: 120 },
  { name:"pubmed_eppley.csv",  desc:"PubMed summary for Eppley-authored papers.",   min: 150 },
  { name:"crossref_works.csv", desc:"Crossref works and DOIs.",                     min: 1200 },
  { name:"openalex_works.csv", desc:"OpenAlex works (IDs, venues, concepts).",      min: 1 },
  { name:"clinical_trials.csv",desc:"ClinicalTrials.gov matches (NCT IDs).",        min: 1 },
  { name:"orcid_profiles.csv", desc:"ORCID profile snapshots.",                      min: 1 },
  { name:"orcid_works.csv",    desc:"ORCID works (titles, years, IDs).",            min: 1 },
  { name:"youtube_all.csv",    desc:"YouTube videos/metadata referencing Eppley.",  min: 20 }
];

// base path (supports root or /docs hosting)
const base = location.pathname.endsWith('/') ? location.pathname : location.pathname.replace(/[^/]+$/, '');
const siteRoot = location.origin + base.replace(/\/docs\/?$/, '/');
const outputBase = siteRoot + 'output/';
document.getElementById('siteUrl').textContent = siteRoot;
document.getElementById('siteUrl').href = siteRoot;

// helpers
async function countCsvRows(url){
  try{
    const r = await fetch(url, { cache:'no-store' });
    if(!r.ok) return { ok:false, rows:0, status:String(r.status), last:'' };
    const txt = await r.text();
    const lines = txt.split(/\r?\n/).filter(Boolean);
    const rows = Math.max(0, lines.length - 1);
    const last = r.headers.get('last-modified') || '';
    return { ok:true, rows, status:'ok', last };
  }catch(e){
    return { ok:false, rows:0, status:'error', last:'' };
  }
}
function fmtUTC(s){ if(!s) return '—'; const d=new Date(s); return isNaN(d)?'—':d.toUTCString().replace('GMT','UTC'); }

// render table skeleton
const tbody = document.querySelector('#files tbody');
FILES.forEach(f=>{
  const tr = document.createElement('tr');
  const href = outputBase + f.name;
  tr.innerHTML = `
    <td><a href="${href}" target="_blank" rel="noopener">${f.name}</a></td>
    <td class="small">${f.desc}</td>
    <td class="num" data-rows>…</td>
    <td data-last>…</td>
    <td data-status>checking…</td>
    <td class="num"><a href="${href}" target="_blank" rel="noopener">CSV</a></td>
  `;
  tbody.appendChild(tr);
});

// audit
(async () => {
  const rowsCells = document.querySelectorAll('[data-rows]');
  const lastCells = document.querySelectorAll('[data-last]');
  const statusCells = document.querySelectorAll('[data-status]');
  let totalRows = 0, present = 0, issues = 0, newest = 0;
  let ytMissingOrEmpty = false;

  for(let i=0;i<FILES.length;i++){
    const f = FILES[i];
    const url = outputBase + f.name;
    const { ok, rows, status, last } = await countCsvRows(url);

    rowsCells[i].textContent = ok ? rows.toLocaleString() : '0';
    lastCells[i].textContent = fmtUTC(last);

    if(ok){
      present++;
      totalRows += rows;
      const t = last ? Date.parse(last) : 0;
      newest = Math.max(newest, t);
      // threshold check
      if(rows >= f.min){
        statusCells[i].innerHTML = `<span class="ok">ok</span>`;
      }else{
        statusCells[i].innerHTML = `<span class="warn">warn</span>`;
        issues++;
        if (f.name === "youtube_all.csv" && rows === 0) ytMissingOrEmpty = true;
      }
    }else{
      statusCells[i].innerHTML = `<span class="err">${status==='404'?'missing':'error'}</span>`;
      issues++;
      if (f.name === "youtube_all.csv") ytMissingOrEmpty = true;
    }
  }

  // summary
  document.getElementById('filesPresent').textContent = `${present}/${FILES.length}`;
  document.getElementById('totalRows').textContent = totalRows.toLocaleString();
  document.getElementById('issueCount').textContent = issues;

  const lastBadge = document.getElementById('lastUpdated');
  lastBadge.textContent = `Last updated: ${newest ? new Date(newest).toUTCString().replace('GMT','UTC') : '—'}`;

  const overall = document.getElementById('overall');
  if(issues === 0){
    overall.classList.add('ok'); overall.textContent = 'overall: passing';
  }else{
    overall.classList.remove('ok');
    overall.classList.add(present ? 'warn' : 'err');
    overall.textContent = present ? 'overall: warnings' : 'overall: failing';
  }

  // explicit YouTube tip if missing or empty
  if (ytMissingOrEmpty) {
    document.getElementById('ytTip').style.display = 'block';
  }
})();
</script>
</body>
</html>