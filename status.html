<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eppley Data Status</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{--fg:#111;--muted:#666;--line:#e6e6ef;--pill:#f7f7fb}
    *{box-sizing:border-box} body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;color:var(--fg)}
    header{padding:22px 18px;border-bottom:1px solid var(--line)} h1{margin:0 0 6px} .sub{margin:0;color:var(--muted)}
    main{max-width:1100px;margin:22px auto;padding:0 16px}
    table{border-collapse:collapse;width:100%} th,td{border:1px solid var(--line);padding:10px;text-align:left;font-size:14px} th{background:var(--pill)}
    .btn{display:inline-block;padding:8px 10px;border:1px solid #111;border-radius:10px;text-decoration:none;color:#111;margin-right:6px}
    .btn:hover{background:#111;color:#fff} .small{color:var(--muted);font-size:12px}
    .meter{background:#f1f1f6;border:1px solid var(--line);border-radius:10px;overflow:hidden;height:16px}
    .bar{height:100%;background:#12a150;width:0%}
    .badges{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    footer{margin:32px 0;padding:16px;color:#666;text-align:center;font-size:12px}
  </style>
</head>
<body>
  <header>
    <h1>Eppley Data Status</h1>
    <p class="sub">Auto-updated from this repo’s <code>output/</code> folder. Live workflow status and crawl progress below.</p>
  </header>

  <main>
    <!-- LIVE workflow badges (no auth needed) -->
    <div class="badges">
      <img alt="Scraper status" src="https://img.shields.io/github/actions/workflow/status/jasonab74-ctrl/eppley-collector/run-scraper.yml?branch=main&label=Scraper">
      <img alt="Status builder" src="https://img.shields.io/github/actions/workflow/status/jasonab74-ctrl/eppley-collector/build-status.yml?branch=main&label=Build%20Status">
    </div>

    <!-- WordPress crawl meter -->
    <section style="margin:14px 0 22px">
      <div class="small" id="wp-head">WordPress crawl progress</div>
      <div class="meter"><div class="bar" id="wp-bar"></div></div>
      <div class="small" id="wp-foot" style="margin-top:6px;"></div>
    </section>

    <div id="meta" class="small"></div>
    <div id="table"></div>
  </main>

  <footer>Tip: right-click a CSV link → “Save link as…” to download directly.</footer>

  <script>
    const REPO = "jasonab74-ctrl/eppley-collector";

    async function fetchJSON(url){
      const r = await fetch(url + "?" + Date.now());
      if(!r.ok) throw new Error(url + " → " + r.status);
      return r.json();
    }

    function fmt(n){ return (n||0).toLocaleString('en-US'); }

    async function loadWPState(){
      try{
        const st = await fetchJSON('output/wp_state.json');
        const completed = st.completed || 0;
        const remaining = (st.queue && st.queue.length) || 0;
        const total = completed + remaining;
        const pct = total ? Math.round((completed/total)*100) : (completed ? 100 : 0);
        document.getElementById('wp-bar').style.width = pct + '%';
        document.getElementById('wp-head').textContent = "WordPress crawl progress";
        document.getElementById('wp-foot').textContent =
          total ? `Completed: ${fmt(completed)} • Remaining (queued): ${fmt(remaining)} • Approx. ${pct}% done` :
                  `No queue yet — first discovery or delta run pending`;
      }catch(e){
        document.getElementById('wp-head').textContent = "WordPress crawl progress";
        document.getElementById('wp-foot').textContent = "No state yet (wp_state.json will appear after the first crawl chunk).";
      }
    }

    async function loadStatus(){
      try{
        const data = await fetchJSON('output/status.json');
        document.getElementById('meta').textContent =
          `Generated: ${data.generated_at} (UTC) • Repo: ${data.repo}`;

        const rows = data.files || [];
        const html = `
          <table>
            <thead>
              <tr>
                <th>File</th>
                <th>Description</th>
                <th>Last Updated (UTC)</th>
                <th>Size</th>
                <th>Total Rows</th>
                <th>New Rows (since last run)</th>
                <th>Links</th>
              </tr>
            </thead>
            <tbody>
              ${rows.map(r => `
                <tr>
                  <td><code>${r.name}</code><div class="small">${r.exists ? '✅ available' : '❌ missing'}</div></td>
                  <td>${r.label || ''}</td>
                  <td>${r.updated_at || ''}</td>
                  <td>${r.size_mb ? r.size_mb + ' MB' : '—'}</td>
                  <td>${r.rows ? fmt(r.rows) : '—'}</td>
                  <td>${r.new_rows_since_last_run ? '+'+fmt(r.new_rows_since_last_run) : '0'}</td>
                  <td>
                    <a class="btn" href="${r.download_url}" target="_blank" rel="noopener">Download CSV</a>
                    <a class="btn" href="${r.webpage_url}" target="_blank" rel="noopener">View on GitHub</a>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>`;
        document.getElementById('table').innerHTML = html;
      }catch(e){
        document.getElementById('table').innerHTML =
          '<p>status.json not found yet. Run “Build Data Status” after the scraper commits, then refresh.</p>';
      }
    }

    loadWPState();
    loadStatus();
  </script>
</body>
</html>