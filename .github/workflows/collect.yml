name: Collect & Build / build

on:
  workflow_dispatch:
  schedule:
    - cron: "23 7 * * *"  # daily 07:23 UTC

# 🔐 REQUIRED so the job can push updated CSV/JSON to your repo
permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # allow pushes

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ---- YOUR SECRETS/VARs ----
      # Settings → Secrets and variables → Actions:
      #   • NCBI_EMAIL      (valid email)
      #   • YT_API_KEY      (if using YouTube)
      # Optional:
      #   • OPENALEX_EMAIL  (else falls back to NCBI_EMAIL)
      - name: Run collectors
        env:
          NCBI_EMAIL: ${{ vars.NCBI_EMAIL }}
          YT_API_KEY: ${{ secrets.YT_API_KEY }}
          OPENALEX_EMAIL: ${{ vars.OPENALEX_EMAIL }}
        run: |
          python main.py
          # sanity print
          ls -lh output || true
          head -n 3 output/status.json || true

      # 🚀 Commit the updated output/* and any badges/json
      - name: Commit updated data
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(data): update output files [skip ci]"
          file_pattern: |
            output/*.csv
            output/*.json
            output/*.ndjson
            output/*.parquet
            output/*.md

      # (Optional) Fail if no changes were produced (helps debugging)
      - name: Check that output changed
        run: |
          if git diff --name-only HEAD~1..HEAD | grep -q '^output/'; then
            echo "Output updated."
          else
            echo "No changes in output/* — check collectors or filters." >&2
          fi