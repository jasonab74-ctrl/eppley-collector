name: Collect & Build

on:
  workflow_dispatch: {}
  schedule:
    # Run daily at 07:15 UTC (12:15 am Phoenix during MST; 11:15 pm during MDT)
    - cron: "15 7 * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pandas python-dateutil

      # ---- RUN YOUR COLLECTORS (unchanged) ----
      - name: Run collector pipeline
        env:
          NCBI_API_KEY: ${{ secrets.NCBI_API_KEY }}
          NCBI_EMAIL:   ${{ secrets.NCBI_EMAIL }}
          YT_API_KEY:   ${{ secrets.YT_API_KEY }}
        run: |
          mkdir -p output
          python main.py

      # ---- WRITE/REFRESH status.json for the site ----
      - name: Write status.json
        run: |
          python scripts/write_status.py

      # ---- Commit any new/changed artifacts (CSV + JSON) ----
      - name: Commit artifacts
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(data): refresh CSVs and status.json"
          file_pattern: |
            output/*.csv
            output/status.json

      # (Optional) build Pages if your site requires it; if your repo already auto-builds, this is harmless
      - name: Touch index to bump pages
        run: |
          echo "<!-- bump $(date -u +%FT%TZ) -->" >> index.html
      - name: Commit bump (no-op if unchanged)
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(site): bump pages build"
          file_pattern: index.html